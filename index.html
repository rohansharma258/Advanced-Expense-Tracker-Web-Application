<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker Pro - Recurring</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #f4f6f8; --card: #fff; --primary: #007bff;
    --income: #28a745; --expense: #dc3545; --text: #111;
  }
  [data-theme="dark"] {
    --bg: #121212; --card: #1e1e1e; --text: #f4f4f4;
  }
  body { margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); padding:20px;}
  h2,h3 { margin:0 0 10px 0; }
  .container { display:grid; grid-template-columns:1fr 1fr; gap:20px;}
  .card { background: var(--card); border-radius:10px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  input, select, button { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
  button { background: var(--primary); color:white; font-weight:bold; cursor:pointer; border:none;}
  button:hover { opacity:0.9;}
  .transactions div { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;}
  .income { color: var(--income);}
  .expense { color: var(--expense);}
  .dark-mode-toggle { cursor:pointer; background:none; border:1px solid var(--text); padding:5px 10px; border-radius:5px; margin-bottom:10px; font-weight:bold;}
  .tx-btn { padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; margin-left: 5px; }
  .cancel-btn { background:#6c757d; margin-top:5px;}
  @media(max-width:768px){ .container{ grid-template-columns:1fr; } }
</style>
</head>
<body data-theme="light">

<h2>Expense Tracker Pro - Recurring</h2>
<button class="dark-mode-toggle" id="themeToggle">Toggle Dark Mode</button>

<div class="container">

  <!-- Left: Form + Transactions -->
  <div class="card">
    <h3>Add / Edit Transaction</h3>
    <form id="txForm">
      <input type="text" id="desc" placeholder="Description" required>
      <input type="number" id="amount" placeholder="Amount" step="0.01" min="0.01" required>
      <input type="date" id="txDate" required>
      <select id="type" required>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
      <select id="category" required>
        <option value="General">General</option>
        <option value="Food">Food</option>
        <option value="Rent">Rent</option>
        <option value="Salary">Salary</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Transport">Transport</option>
      </select>
      <select id="recurring">
        <option value="none">Recurring: None</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <button type="submit" id="submitBtn">Add Transaction</button>
      <button type="button" class="cancel-btn" id="cancelEdit" style="display:none;">Cancel</button>
    </form>

    <hr>
    <h3>Transactions</h3>
    <label>Filter by Category:</label>
    <select id="filterCat">
      <option value="All">All</option>
      <option value="General">General</option>
      <option value="Food">Food</option>
      <option value="Rent">Rent</option>
      <option value="Salary">Salary</option>
      <option value="Entertainment">Entertainment</option>
      <option value="Transport">Transport</option>
    </select>
    <label>Date Range:</label>
    <input type="date" id="startDate"> to <input type="date" id="endDate">
    <button type="button" id="applyDateFilter">Apply Date Filter</button>

    <div id="transactions" class="transactions"></div>
  </div>

  <!-- Right: Summary + Charts -->
  <div class="card">
    <h3>Summary</h3>
    <p>Balance: <strong id="balance">‚Çπ0.00</strong></p>
    <p class="income">Income: <strong id="totalIncome">‚Çπ0.00</strong></p>
    <p class="expense">Expense: <strong id="totalExpense">‚Çπ0.00</strong></p>
    <canvas id="pieChart" width="400" height="300"></canvas>
    <h3 style="margin-top:20px;">Monthly Trend</h3>
    <canvas id="lineChart" width="400" height="200"></canvas>
  </div>

</div>

<script>
const form=document.getElementById("txForm");
const descInput=document.getElementById("desc");
const amountInput=document.getElementById("amount");
const typeInput=document.getElementById("type");
const categoryInput=document.getElementById("category");
const txDateInput=document.getElementById("txDate");
const recurringInput=document.getElementById("recurring");
const txContainer=document.getElementById("transactions");
const balanceEl=document.getElementById("balance");
const incomeEl=document.getElementById("totalIncome");
const expenseEl=document.getElementById("totalExpense");
const themeToggle=document.getElementById("themeToggle");
const filterCat=document.getElementById("filterCat");
const startDateInput=document.getElementById("startDate");
const endDateInput=document.getElementById("endDate");
const cancelEditBtn=document.getElementById("cancelEdit");
const submitBtn=document.getElementById("submitBtn");
const applyDateFilterBtn=document.getElementById("applyDateFilter");

let transactions=JSON.parse(localStorage.getItem("transactions"))||[];
let pieChart=null,lineChart=null;
let editIndex=null;

// Default date is today
txDateInput.valueAsDate = new Date();

function formatCurrency(num){ return "‚Çπ"+Number(num).toFixed(2); }

function filterTransactionsByDate(trans){ 
  const start=startDateInput.value ? new Date(startDateInput.value) : null;
  const end=endDateInput.value ? new Date(endDateInput.value) : null;
  return trans.filter(t=>{
    const d=new Date(t.date);
    if(start && d<start) return false;
    if(end && d>end) return false;
    return true;
  });
}

function updateRecurringTransactions(){
  const today = new Date();
  let newTransactions = [];
  transactions.forEach(t=>{
    if(t.recurring && t.recurring!=='none'){
      let last = t.lastGenerated ? new Date(t.lastGenerated) : new Date(t.date);
      while(last < today){
        let nextDate = new Date(last);
        if(t.recurring==='daily') nextDate.setDate(last.getDate()+1);
        else if(t.recurring==='weekly') nextDate.setDate(last.getDate()+7);
        else if(t.recurring==='monthly') nextDate.setMonth(last.getMonth()+1);

        if(nextDate <= today){
          newTransactions.push({
            desc: t.desc,
            amount: t.amount,
            type: t.type,
            category: t.category,
            date: nextDate.toISOString().slice(0,10),
            recurring: t.recurring,
            lastGenerated: nextDate.toISOString().slice(0,10)
          });
          last = nextDate;
        } else break;
      }
      t.lastGenerated = last.toISOString().slice(0,10);
    }
  });
  transactions = transactions.concat(newTransactions);
  localStorage.setItem("transactions",JSON.stringify(transactions));
}

function updateSummary(filtered=null){
  const trans = filtered || transactions;
  let income=0,expense=0,categoryTotals={};
  trans.forEach(t=>{
    if(t.type==="income") income+=t.amount; else expense+=t.amount;
    if(!categoryTotals[t.category]) categoryTotals[t.category]=0;
    categoryTotals[t.category]+=t.amount;
  });
  balanceEl.textContent=formatCurrency(income-expense);
  incomeEl.textContent=formatCurrency(income);
  expenseEl.textContent=formatCurrency(expense);
  renderPieChart(categoryTotals);
  renderLineChart(trans);
}

function renderTransactions(filtered=null){
  const trans = filtered || transactions;
  const filter=filterCat.value;
  txContainer.innerHTML="";
  trans.forEach((t,index)=>{
    if(filter!=="All" && t.category!==filter) return;
    const div=document.createElement("div");
    div.innerHTML=`
      <span>${t.desc} (${t.category}) ${t.recurring!=='none'?'üîÅ':''} - ${t.type} [${t.date}]</span>
      <span class="${t.type}">${formatCurrency(t.amount)}</span>
      <button class="tx-btn" onclick="editTransaction(${index})">‚úèÔ∏è</button>
      <button class="tx-btn" onclick="deleteTransaction(${index})">‚ùå</button>
    `;
    txContainer.appendChild(div);
  });
}

function renderPieChart(categoryTotals){
  const ctx=document.getElementById("pieChart").getContext("2d");
  if(pieChart) pieChart.destroy();
  const labels=Object.keys(categoryTotals);
  const data=Object.values(categoryTotals);
  const colors=["#28a745","#dc3545","#ffc107","#17a2b8","#6f42c1","#fd7e14"];
  pieChart=new Chart(ctx,{type:"pie",data:{labels,datasets:[{data, backgroundColor:colors}]},
    options:{plugins:{tooltip:{callbacks:{label:function(c){const total=data.reduce((a,b)=>a+b,0); const val=c.raw; const perc=total?((val/total)*100).toFixed(1):0; return `${c.label}: ${formatCurrency(val)} (${perc}%)`;}}}}}});
}

function renderLineChart(filtered=null){
  const trans = filtered || transactions;
  const monthly={};
  trans.forEach(t=>{
    const d=new Date(t.date);
    const key=`${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
    if(!monthly[key]) monthly[key]={income:0,expense:0};
    if(t.type==="income") monthly[key].income+=t.amount; else monthly[key].expense+=t.amount;
  });
  const labels=Object.keys(monthly).sort();
  const incomeData=labels.map(k=>monthly[k].income);
  const expenseData=labels.map(k=>monthly[k].expense);
  const ctx=document.getElementById("lineChart").getContext("2d");
  if(lineChart) lineChart.destroy();
  lineChart=new Chart(ctx,{
    type:"line",
    data:{labels,datasets:[
      {label:"Income",data:incomeData,borderColor:"#28a745",backgroundColor:"rgba(40,184,69,0.2)", tension:0.3},
      {label:"Expense",data:expenseData,borderColor:"#dc3545",backgroundColor:"rgba(220,53,69,0.2)", tension:0.3}
    ]},
    options:{responsive:true,plugins:{tooltip:{mode:'index',intersect:false}},interaction:{mode:'nearest',axis:'x',intersect:false}}
  });
}

function addTransaction(e){
  e.preventDefault();
  const desc=descInput.value.trim();
  const amount=parseFloat(amountInput.value);
  const type=typeInput.value;
  const category=categoryInput.value;
  const date=txDateInput.value;
  const recurring=recurringInput.value;
  if(!desc||isNaN(amount)||amount<=0||!date) return alert("Enter valid details");

  if(editIndex!==null){
    transactions[editIndex]={desc,amount,type,category,date,recurring, lastGenerated:date};
    editIndex=null;
    submitBtn.textContent="Add Transaction";
    cancelEditBtn.style.display="none";
  } else {
    transactions.push({desc,amount,type,category,date,recurring,lastGenerated:date});
  }

  localStorage.setItem("transactions",JSON.stringify(transactions));
  form.reset();
  txDateInput.valueAsDate=new Date();
  recurringInput.value="none";
  renderTransactions();
  updateSummary();
}

function editTransaction(index){
  const t=transactions[index];
  descInput.value=t.desc;
  amountInput.value=t.amount;
  typeInput.value=t.type;
  categoryInput.value=t.category;
  txDateInput.value=t.date;
  recurringInput.value=t.recurring || "none";
  editIndex=index;
  submitBtn.textContent="Update Transaction";
  cancelEditBtn.style.display="inline-block";
}

function cancelEdit(){
  editIndex=null;
  form.reset();
  txDateInput.valueAsDate = new Date();
  recurringInput.value="none";
  submitBtn.textContent="Add Transaction";
  cancelEditBtn.style.display="none";
}

function deleteTransaction(index){
  transactions.splice(index,1);
  localStorage.setItem("transactions",JSON.stringify(transactions));
  renderTransactions();
  updateSummary();
}

// Event Listeners
themeToggle.addEventListener("click",()=>{ document.body.setAttribute("data-theme", document.body.getAttribute("data-theme")==="light"?"dark":"light"); });
filterCat.addEventListener("change",()=>{ const filtered = filterTransactionsByDate(transactions); renderTransactions(filtered); updateSummary(filtered); });
applyDateFilterBtn.addEventListener("click",()=>{ const filtered = filterTransactionsByDate(transactions); renderTransactions(filtered); updateSummary(filtered); });
cancelEditBtn.addEventListener("click",cancelEdit);
form.addEventListener("submit",addTransaction);

// Initialize
updateRecurringTransactions();
renderTransactions();
updateSummary();
</script>

</body>
</html>
